<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plasma Lab Booking – Supabase</title>

  <!-- ✅ 固定 Supabase 配置 -->
  <script>
    window.SUPABASE_URL = "https://mbaacwnxdkeseiqybvrj.supabase.co";
    window.SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1iYWFjd254ZGtlc2VpcXlidnJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNzg5MzEsImV4cCI6MjA3MzY1NDkzMX0.vjQhoXxkSK3xTgqKh_sThN-6jIkzAcePtfkpnkt1Eq8";
  </script>

  <!-- Supabase JS SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #f5f7fa;
    }
    h1 {
      color: #2b7cff;
    }
    .card {
      border: 1px solid #ccc;
      padding: 16px;
      margin-bottom: 20px;
      border-radius: 8px;
      background: white;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      margin-top: 10px;
      padding: 10px 16px;
      background: #2b7cff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button.danger {
      background: #e05656;
    }
    .booking {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 6px 0;
      border-radius: 6px;
      background: #fafafa;
    }
    .admin-box {
      margin-top: 30px;
      padding: 12px;
      border: 1px dashed #aaa;
      border-radius: 6px;
      background: #fffbe6;
    }
  </style>
</head>
<body>
  <h1>Plasma Bioengineering Lab – Device Booking</h1>

  <!-- Booking Form -->
  <div class="card">
    <h2>Book a Device</h2>
    <label>Device
      <select id="device">
        <option>Main Plasma system (PIII and IAPP)</option>
        <option>Horizontal plasma chamber</option>
        <option>Atmospheric plasma jet (APPJ)</option>
        <option>Contact angle measurement (EC112)</option>
        <option>ATR-FTIR (EC112)</option>
        <option>UV-VIS (EC112)</option>
        <option>Microscope</option>
      </select>
    </label>
    <label>Date <input type="date" id="date" /></label>
    <label>Start time <input type="time" id="start" /></label>
    <label>End time <input type="time" id="end" /></label>
    <label>Your name <input type="text" id="name" /></label>
    <label>Email <input type="email" id="email" /></label>
    <label>Notes <textarea id="notes"></textarea></label>
    <button onclick="bookNow()">➕ Book now</button>
  </div>

  <!-- Upcoming Bookings -->
  <div class="card">
    <h2>Upcoming bookings</h2>
    <div id="bookings"></div>
  </div>

  <!-- Admin Tools -->
  <div class="admin-box">
    <h3>Admin – One-time SQL for Supabase</h3>
    <p>在 Supabase SQL Editor 中运行以下脚本，初始化数据库：</p>
<pre>
create table if not exists public.bookings (
  id bigint generated by default as identity primary key,
  device text not null,
  date date not null,
  start time not null,
  "end" time not null,
  name text,
  email text,
  notes text,
  tsrange tsrange generated always as (
    tsrange(
      (date::timestamp + start),
      (date::timestamp + "end")
    )
  ) stored,
  constraint no_overlap exclude using gist (device with =, tsrange with &&)
);

alter table public.bookings enable row level security;

create policy "public read" on public.bookings for select to anon using (true);
create policy "public insert" on public.bookings for insert to anon with check (true);
create policy "public update" on public.bookings for update to anon using (true) with check (true);
create policy "public delete" on public.bookings for delete to anon using (true);
</pre>
  </div>

  <script>
    const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    async function fetchBookings() {
      const { data, error } = await supabase
        .from("bookings")
        .select("*")
        .order("date", { ascending: true })
        .order("start", { ascending: true });
      if (error) {
        console.error(error);
        return;
      }
      const bookingsDiv = document.getElementById("bookings");
      bookingsDiv.innerHTML = "";
      data.forEach((b) => {
        const div = document.createElement("div");
        div.className = "booking";
        div.innerHTML = `
          <b>${b.device}</b> – ${b.date} ${b.start}–${b.end}<br/>
          ${b.name} (${b.email})<br/>
          Notes: ${b.notes || ""}<br/>
          <button onclick="deleteBooking(${b.id})" class="danger">Delete</button>
        `;
        bookingsDiv.appendChild(div);
      });
    }

    async function bookNow() {
      const device = document.getElementById("device").value;
      const date = document.getElementById("date").value;
      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;
      const name = document.getElementById("name").value;
      const email = document.getElementById("email").value;
      const notes = document.getElementById("notes").value;

      const { error } = await supabase.from("bookings").insert([
        { device, date, start, end, name, email, notes },
      ]);
      if (error) {
        alert("❌ Error: " + error.message);
      } else {
        alert("✅ Booking created!");
        fetchBookings();
      }
    }

    async function deleteBooking(id) {
      if (!confirm("Delete this booking?")) return;
      const { error } = await supabase.from("bookings").delete().eq("id", id);
      if (error) {
        alert("❌ Error: " + error.message);
      } else {
        fetchBookings();
      }
    }

    // 实时监听
    supabase
      .channel("table-db-changes")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "bookings" },
        (payload) => {
          fetchBookings();
        }
      )
      .subscribe();

    fetchBookings();
  </script>
</body>
</html>