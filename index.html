<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plasma Lab Booking â€“ Supabase</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 0; background:#f6f9ff; }
  .container { max-width: 1000px; margin: 0 auto; padding: 22px; }
  h1 { margin: 0 0 6px; color:#0e1726; }
  .sub { color:#5b6b80; margin-bottom:14px }
  .card { background:#fff; border:1px solid #e1e9ff; border-radius:14px; box-shadow:0 6px 24px rgba(16,37,71,.06); margin-bottom:14px }
  .section { padding:16px }
  label { display:block; font-size:.9rem; color:#5b6b80; margin:6px 0 2px }
  input, select, textarea { width:100%; padding:10px 12px; border:1px solid #d7e2ff; border-radius:12px }
  textarea { min-height:80px }
  .row { display:grid; gap:12px }
  @media(min-width:640px){ .row{ grid-template-columns:1fr 1fr } }
  .btn { padding:10px 14px; border-radius:12px; border:1px solid #cfe0ff; background:#2b7fff; color:#fff; cursor:pointer }
  .btn.ghost { background:#fff; color:#2456d1 }
  .btn.danger { background:#e05666; border-color:#f6c9ce }
  .list { display:flex; flex-direction:column; gap:10px }
  .item { border:1px solid #e8eef8; border-radius:12px; padding:12px; display:flex; justify-content:space-between }
  .muted { color:#5b6b80 }
  .msg { margin: 8px 0; }
  .ok{color:#0b7a45} .err{color:#b4232c}
</style>
</head>

<body>
<div class="container">
  <h1>Plasma Bioengineering Lab â€“ Device Booking</h1>
  <div class="sub">Supabase backend â€¢ RPC booking â€¢ Realtime</div>
  <div id="msg" class="msg"></div>

  <div class="card"><div class="section">
    <h2>Book a Device</h2>

    <div class="row">
      <div>
        <label>Device</label>
        <select id="device">
          <option>Main Plasma system (PIII and IAPP)</option>
          <option>Horizontal plasma chamber</option>
          <option>Atmospheric plasma jet (APPJ)</option>
          <option>Wettability / Contact angle measurement (EC112)</option>
          <option>ATR-FTIR (EC112)</option>
          <option>UV-Vis (EC112)</option>
          <option>Microscope</option>
        </select>
      </div>
      <div>
        <label>Date</label>
        <input type="date" id="date" />
      </div>
    </div>

    <div class="row">
      <div><label>Start</label><input type="time" id="start" /></div>
      <div><label>End</label><input type="time" id="end" /></div>
    </div>

    <div class="row">
      <div><label>Your name</label><input id="name" /></div>
      <div><label>Email</label><input id="email" type="email" /></div>
    </div>

    <div><label>Notes</label><textarea id="notes"></textarea></div>

    <div style="margin-top:10px;display:flex;gap:10px">
      <button id="book" class="btn">âž• Book now</button>
      <button id="cancelEdit" class="btn ghost" style="display:none">Cancel edit</button>
    </div>
  </div></div>

  <div class="card"><div class="section">
    <h2>Upcoming bookings</h2>
    <div id="list" class="list"></div>
    <div id="empty" class="muted">No bookings yet.</div>
  </div></div>
</div>

<script>
/* ========= Supabase ========= */
const SUPABASE_URL = "https://mbaacwnxdkeseiqybvrj.supabase.co";
const SUPABASE_KEY = "ä½ çš„ anon keyï¼ˆä¿æŒä½ åŽŸæ¥çš„ï¼‰";
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ========= Helpers ========= */
const $ = (id)=>document.getElementById(id);
function setMsg(t, ok=false){
  $('msg').innerHTML = t ? `<span class="${ok?'ok':'err'}">${t}</span>` : '';
}

/* ========= List ========= */
async function listBookings(){
  const today = new Date().toISOString().slice(0,10);
  const { data, error } = await supabaseClient
    .from('bookings')
    .select('*')
    .gte('date', today)
    .order('date')
    .order('start');

  const list = $('list');
  const empty = $('empty');
  list.innerHTML = '';

  if(error){
    setMsg(error.message);
    empty.style.display='block';
    return;
  }

  data.forEach(b=>{
    const div = document.createElement('div');
    div.className='item';
    div.innerHTML = `
      <div>
        <strong>${b.device}</strong><br/>
        <span class="muted">${b.date} â€¢ ${b.start} â€“ ${b.end}</span><br/>
        <span class="muted">${b.name} Â· ${b.email}</span>
      </div>
      <button class="btn danger" onclick="removeBooking('${b.id}')">ðŸ—‘</button>
    `;
    list.appendChild(div);
  });

  empty.style.display = data.length ? 'none':'block';
}

/* ========= Booking ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  $('date').value = new Date().toISOString().slice(0,10);
  listBookings();

  $('book').addEventListener('click', async ()=>{
    const booking = {
      device: $('device').value,
      date: $('date').value,
      start: $('start').value,
      end: $('end').value,
      name: $('name').value.trim(),
      email: $('email').value.trim(),
      notes: $('notes').value.trim()
    };

    if(!booking.device || !booking.date || !booking.start || !booking.end || !booking.name || !booking.email){
      setMsg('Please complete all required fields.');
      return;
    }

    if(booking.end <= booking.start){
      setMsg('End time must be after start.');
      return;
    }

    const { error } = await supabaseClient.rpc('create_booking', {
      p_device: booking.device,
      p_date: booking.date,
      p_start: booking.start,
      p_end: booking.end,
      p_name: booking.name,
      p_email: booking.email,
      p_notes: booking.notes || null
    });

    if(error){
      setMsg(
        error.message.includes('already booked')
          ? 'Time conflict: already booked.'
          : error.message
      );
      return;
    }

    setMsg('Booked successfully!', true);
    listBookings();
  });
});

/* ========= Delete ========= */
async function removeBooking(id){
  if(!confirm('Delete this booking?')) return;
  const { error } = await supabaseClient.from('bookings').delete().eq('id', id);
  if(error) setMsg(error.message);
  else { setMsg('Deleted.', true); listBookings(); }
}

/* ========= Realtime ========= */
supabaseClient
  .channel('bookings-changes')
  .on('postgres_changes',{event:'*',schema:'public',table:'bookings'},listBookings)
  .subscribe();
</script>
</body>
</html>
