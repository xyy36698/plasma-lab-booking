<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plasma Lab Booking ‚Äì Supabase (Open Edit/Delete) + Admin Settings</title>
<style>
  :root{--card:#ffffff;--ink:#0e1726;--muted:#5b6b80;--prim:#2b7fff;--danger:#e05666}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#f7fbff,#eef3ff)}
  .container{max-width:1100px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0}
  h1{font-size:1.35rem;margin:0;color:var(--ink)}
  .sub{color:var(--muted);font-size:.9rem;margin-top:2px}
  .brand{display:flex;align-items:center;gap:10px}
  .badge{background:#eef4ff;color:#2456d1;border:1px solid #dce8ff;border-radius:14px;padding:4px 10px;font-size:.75rem}
  .grid{display:grid;gap:16px}
  @media(min-width:960px){.grid{grid-template-columns:2fr 1fr}}
  .card{background:var(--card);border:1px solid #e7edf7;border-radius:16px;box-shadow:0 6px 24px rgba(16,37,71,.06)}
  .card h2{margin:0 0 10px 0;font-size:1rem;color:var(--ink)}
  .section{padding:18px}
  .row{display:grid;gap:12px}
  @media(min-width:640px){.row{grid-template-columns:1fr 1fr}}
  label{display:block;font-size:.85rem;color:var(--muted);margin:4px 0}
  select,input,textarea,button{font:inherit}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid #d9e2f0;border-radius:12px;background:#fcfdff}
  textarea{min-height:84px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #cfe0ff;background:#2b7fff;color:#fff;cursor:pointer}
  .btn.small{padding:6px 10px;border-radius:10px;font-size:.85rem}
  .btn.danger{background:var(--danger);border-color:#f6c9ce}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{border:1px solid #e8eef8;border-radius:12px;padding:12px 12px;display:flex;justify-content:space-between;gap:10px}
  .muted{color:var(--muted)}
  .pill{display:inline-block;border:1px solid #dfe8f8;background:#f7faff;padding:3px 8px;border-radius:999px;font-size:.75rem}
  .error{color:#b4232c;font-size:.9rem}
  .success{color:#0b7a45;font-size:.9rem}
  .footer{color:#7a8699;text-align:center;font-size:.78rem;margin:28px 0}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/200/svg"><circle cx="12" cy="12" r="10" stroke="#2b7fff" stroke-width="2"/><path d="M12 6v12M6 12h12" stroke="#2b7fff" stroke-width="2"/></svg>
        <div>
          <h1>Plasma Bioengineering Lab ‚Äì Device Booking</h1>
          <div class="sub">Supabase backend ‚Ä¢ open edit/delete ‚Ä¢ email confirmation (Admin-configurable)</div>
        </div>
      </div>
      <span class="badge">Admin code: <span id="codehint">admin123</span></span>
    </header>

    <div class="grid">
      <div class="card">
        <div class="section">
          <h2>Book a Device</h2>
          <div id="msg"></div>
          <div class="row">
            <div>
              <label>Device</label>
              <select id="device"></select>
            </div>
            <div>
              <label>Date</label>
              <input type="date" id="date" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Start time</label>
              <select id="start"></select>
            </div>
            <div>
              <label>End time</label>
              <select id="end"></select>
            </div>
          </div>
          <div>
            <label>Notes (optional)</label>
            <textarea id="notes" placeholder="Sample ID, gas mix, power, etc."></textarea>
          </div>
          <div class="row" style="grid-template-columns:1fr 1fr;">
            <div>
              <label>Your name</label>
              <input id="name" placeholder="Jane Doe" />
            </div>
            <div>
              <label>Email for confirmation</label>
              <input id="email" type="email" placeholder="you@lab.edu" />
            </div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
            <button id="book" class="btn">‚ûï Book now</button>
            <button id="cancelEdit" class="btn" style="display:none;background:#fff;color:#2456d1;border:1px solid #cfe0ff">Cancel edit</button>
            <span id="blockedTip" class="pill" style="display:none">This date is blocked</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section">
          <h2>Upcoming bookings</h2>
          <div id="list" class="list"></div>
          <div id="empty" class="muted">No bookings yet.</div>
        </div>
      </div>
    </div>

    <!-- Admin Panel -->
    <div class="card" id="adminCard">
      <div class="section">
        <h2>Admin ‚Äì Settings</h2>
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
          <input id="adminCodeInput" placeholder="Enter admin code" style="max-width:200px"/>
          <button id="unlock" class="btn">üîê Admin</button>
          <button id="exitAdmin" class="btn" style="display:none;background:#fff;color:#2456d1;border:1px solid #cfe0ff">Exit</button>
        </div>

        <div id="adminBody" style="display:none">
          <div class="row">
            <div>
              <h3 style="margin:6px 0">Business hours</h3>
              <label>Open</label>
              <input id="open" type="time" />
              <label>Close</label>
              <input id="close" type="time" />
              <label>Slot length (minutes)</label>
              <input id="slotmins" type="number" min="5" />
            </div>
            <div>
              <h3 style="margin:6px 0">Connections</h3>
              <label>Supabase URL</label>
              <input id="sbUrl" placeholder="https://YOUR-PROJECT.supabase.co" />
              <label>Supabase anon key</label>
              <input id="sbKey" placeholder="ey... (anon key)" />
              <h3 style="margin:12px 0 6px">Email (optional, EmailJS)</h3>
              <label>EmailJS public key</label>
              <input id="emailjsKey" placeholder="public_xxx" />
              <label>EmailJS service ID</label>
              <input id="emailjsService" placeholder="service_xxx" />
              <label>EmailJS template ID</label>
              <input id="emailjsTemplate" placeholder="template_xxx" />
              <div class="muted" style="font-size:.8rem;margin-top:6px">If filled, a confirmation email will be sent to the booker's email after success.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">Open edit/delete per lab policy. Admin panel holds Supabase & EmailJS config. Realtime + DB conflict prevention.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
(function(){
  const storage = { get(k, fb){ try{ return JSON.parse(localStorage.getItem(k) || 'null') ?? fb }catch(e){ return fb } }, set(k,v){ localStorage.setItem(k, JSON.stringify(v)) } };

  const DEFAULT_DEVICES = [
    { id:'dev-main-plasma', name:'Main Plasma system (PIII and IAPP)' },
    { id:'dev-horizontal-plasma', name:'Horizontal plasma chamber' },
    { id:'dev-appj', name:'Atmospheric plasma jet (APPJ)' },
    { id:'dev-wettability-ec112', name:'Wettability / Contact angle measurement (EC112)' },
    { id:'dev-atr-ftir-ec112', name:'ATR-FTIR (EC112)' },
    { id:'dev-uv-vis-ec112', name:'UV-Vis (EC112)' },
    { id:'dev-microscope', name:'Microscope' }
  ];

  const DEFAULT_HOURS = { open:'09:00', close:'17:00', slotMins: 30 };
  const DEFAULT_SETTINGS = { adminCode:'admin123', blockedDates: [], sbUrl:'', sbKey:'', emailjsKey:'', emailjsService:'', emailjsTemplate:'' };

  let devices   = storage.get('plasma.devices', DEFAULT_DEVICES);
  let hours     = storage.get('plasma.hours',   DEFAULT_HOURS);
  let settings  = storage.get('plasma.settings',DEFAULT_SETTINGS);

  const $ = (id)=> document.getElementById(id);
  const elDevice=$('device'), elDate=$('date'), elStart=$('start'), elEnd=$('end');
  const elName=$('name'), elEmail=$('email'), elNotes=$('notes');
  const elBook=$('book'), elCancelEdit=$('cancelEdit'), elList=$('list'), elEmpty=$('empty'), elMsg=$('msg'), elBlockedTip=$('blockedTip');
  const elAdminBody=$('adminBody'), elAdminCodeInput=$('adminCodeInput'), elUnlock=$('unlock'), elExit=$('exitAdmin');
  const elOpen=$('open'), elClose=$('close'), elSlotM=$('slotmins');
  const elSbUrl=$('sbUrl'), elSbKey=$('sbKey');
  const elEmailJsKey=$('emailjsKey'), elEmailJsService=$('emailjsService'), elEmailJsTpl=$('emailjsTemplate');

  document.getElementById('codehint').textContent = settings.adminCode;

  // Supabase
  let supabase = null;
  function connectSupabase(){
    if(settings.sbUrl && settings.sbKey){ supabase = window.supabase.createClient(settings.sbUrl, settings.sbKey); subscribeRealtime(); listFuture(); }
    else { supabase = null; }
  }
  connectSupabase();

  // EmailJS
  function initEmailJs(){ if(settings.emailjsKey){ emailjs.init(settings.emailjsKey); } }
  initEmailJs();

  // Helpers
  const today = new Date().toISOString().slice(0,10);
  function pad(n){ return String(n).padStart(2,'0') }
  function generateTimes(dateStr){
    const [oH,oM] = hours.open.split(':').map(Number);
    const [cH,cM] = hours.close.split(':').map(Number);
    const start = new Date(dateStr+'T'+pad(oH)+':'+pad(oM)+':00');
    const end   = new Date(dateStr+'T'+pad(cH)+':'+pad(cM)+':00');
    const out=[]; for(let t=new Date(start); t<=end; t=new Date(t.getTime()+hours.slotMins*60000)) out.push(t.toTimeString().slice(0,5));
    return out;
  }
  function escapeHtml(s){ return String(s).replace(/[&<>]/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]) ); }
  function setMsg(text, ok){ elMsg.innerHTML = text ? `<div class="${ok?'success':'error'}">${escapeHtml(text)}</div>` : '' }

  function populateDevices(){ elDevice.innerHTML = devices.map(d=>`<option value="${d.id}">${escapeHtml(d.name)}</option>`).join(''); }

  function refreshTimeSelectors(){
    const dateStr = elDate.value; const blocked = settings.blockedDates.includes(dateStr);
    elBlockedTip.style.display = blocked ? 'inline-block' : 'none'; elBook.disabled = blocked;
    const times = generateTimes(dateStr);
    elStart.innerHTML = times.slice(0,-1).map(t=>`<option value="${t}">${t}</option>`).join('');
    const setEnds=()=>{ const i = times.indexOf(elStart.value); const opts = i>=0? times.slice(i+1):[]; elEnd.innerHTML = opts.map(t=>`<option value="${t}">${t}</option>`).join('') || '<option>No end times</option>'; if(opts.length) elEnd.value = opts[0]; };
    setEnds(); elStart.onchange=setEnds;
  }

  let editingId = null;

  async function listFuture(){
    if(!supabase){ elEmpty.style.display='block'; elList.innerHTML=''; return; }
    const { data, error } = await supabase
      .from('bookings')
      .select('*')
      .gte('date', today)
      .order('date', { ascending: true })
      .order('start', { ascending: true });
    if(error){ setMsg('Load failed: '+error.message); return; }
    elList.innerHTML='';
    (data||[]).forEach(b=>{
      const wrap = document.createElement('div'); wrap.className='item';
      wrap.innerHTML = `
        <div>
          <div><strong>${escapeHtml(b.device_id)}</strong></div>
          <div class="muted">${b.date} ‚Ä¢ ${b.start}‚Äì${b.end}</div>
          <div class="muted">${escapeHtml(b.name)} ¬∑ ${escapeHtml(b.email)}</div>
          ${b.notes? `<div class="muted" style="font-size:.78rem;margin-top:4px">${escapeHtml(b.notes)}</div>`:''}
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <button class="btn small" data-edit="${b.id}">‚úèÔ∏è Edit</button>
          <button class="btn small danger" data-del="${b.id}">üóëÔ∏è Delete</button>
        </div>`;
      elList.appendChild(wrap);
    });
    elEmpty.style.display = (data||[]).length? 'none':'block';
  }

  async function insertBooking(b){
    if(!supabase){ setMsg('Supabase not configured. Open Admin and fill URL & anon key.'); return; }
    const { data, error } = await supabase.from('bookings').insert({
      device_id: b.deviceId, date: b.date, start: b.start, end: b.end,
      name: b.name, email: b.email, notes: b.notes
    }).select();
    if(error){
      if(error.code==='23P01' || /overlap|exclusion|conflict/i.test(error.message)){
        setMsg('Time conflict: this time period is already booked.');
      } else { setMsg('Create failed: '+error.message); }
    } else {
      setMsg('Booked successfully!', true);
      if(settings.emailjsKey && settings.emailjsService && settings.emailjsTemplate && b.email){
        emailjs.send(settings.emailjsService, settings.emailjsTemplate, {
          to_email: b.email,
          user_name: b.name || b.email,
          device: b.deviceId, date: b.date, start: b.start, end: b.end, notes: b.notes || ''
        }).then(()=>{},()=>{});
      }
    }
  }

  async function updateBooking(id, b){
    const { data, error } = await supabase.from('bookings')
      .update({
        device_id: b.deviceId, date: b.date, start: b.start, end: b.end,
        name: b.name, email: b.email, notes: b.notes
      })
      .eq('id', id)
      .select();
    if(error){
      if(error.code==='23P01' || /overlap|exclusion|conflict/i.test(error.message)){
        setMsg('Time conflict on update.');
      } else { setMsg('Update failed: '+error.message); }
    } else { setMsg('Updated!', true); }
  }

  async function deleteBooking(id){
    const { error } = await supabase.from('bookings').delete().eq('id', id);
    if(error){ setMsg('Delete failed: '+error.message); } else { setMsg('Deleted.', true); }
  }

  function subscribeRealtime(){
    if(!supabase) return;
    supabase.channel('bookings-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'bookings' }, () => { listFuture(); })
      .subscribe();
  }

  // Init UI
  function initUI(){
    populateDevices();
    const ds = new Date().toISOString().slice(0,10);
    elDate.value = ds;
    refreshTimeSelectors(); listFuture(); subscribeRealtime();
  }
  initUI();

  // Admin lock/unlock
  elOpen.value = hours.open; elClose.value = hours.close; elSlotM.value = hours.slotMins;
  elSbUrl.value = settings.sbUrl; elSbKey.value = settings.sbKey;
  elEmailJsKey.value = settings.emailjsKey; elEmailJsService.value = settings.emailjsService; elEmailJsTpl.value = settings.emailjsTemplate;

  elUnlock.addEventListener('click', ()=>{
    if(elAdminCodeInput.value===settings.adminCode){
      document.getElementById('adminBody').style.display='block';
      elExit.style.display='inline-flex';
      elUnlock.style.display='none';
    } else { alert('Wrong code'); }
  });
  elExit.addEventListener('click', ()=>{
    document.getElementById('adminBody').style.display='none';
    elExit.style.display='none';
    elUnlock.style.display='inline-flex';
  });

  elOpen.addEventListener('change', (e)=>{ hours.open=e.target.value; storage.set('plasma.hours', hours); refreshTimeSelectors(); });
  elClose.addEventListener('change', (e)=>{ hours.close=e.target.value; storage.set('plasma.hours', hours); refreshTimeSelectors(); });
  elSlotM.addEventListener('change', (e)=>{ hours.slotMins=Math.max(5,Number(e.target.value||30)); storage.set('plasma.hours', hours); refreshTimeSelectors(); });

  elSbUrl.addEventListener('input', (e)=>{ settings.sbUrl=e.target.value.trim(); storage.set('plasma.settings', settings); connectSupabase(); });
  elSbKey.addEventListener('input', (e)=>{ settings.sbKey=e.target.value.trim(); storage.set('plasma.settings', settings); connectSupabase(); });
  elEmailJsKey.addEventListener('input', (e)=>{ settings.emailjsKey=e.target.value.trim(); storage.set('plasma.settings', settings); initEmailJs(); });
  elEmailJsService.addEventListener('input', (e)=>{ settings.emailjsService=e.target.value.trim(); storage.set('plasma.settings', settings); });
  elEmailJsTpl.addEventListener('input', (e)=>{ settings.emailjsTemplate=e.target.value.trim(); storage.set('plasma.settings', settings); });

  // List actions
  elList.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const delId = btn.getAttribute('data-del'); const editId = btn.getAttribute('data-edit');
    if(delId){ if(confirm('Delete this booking?')) deleteBooking(delId); return; }
    if(editId){
      supabase.from('bookings').select('*').eq('id', editId).single().then(({data, error})=>{
        if(error){ setMsg('Failed to load booking: '+error.message); return; }
        editingId = data.id;
        elDevice.value = data.device_id;
        elDate.value = data.date;
        refreshTimeSelectors();
        elStart.value = data.start;
        const times = Array.from(elEnd.options).map(o=>o.value);
        if(!times.includes(data.end)){ const opt=document.createElement('option'); opt.value=data.end; opt.textContent=data.end; elEnd.appendChild(opt); }
        elEnd.value = data.end;
        elName.value = data.name; elEmail.value = data.email; elNotes.value = data.notes||'';
        elBook.textContent = 'üíæ Save changes';
        elCancelEdit.style.display = 'inline-flex';
        window.scrollTo({top:0, behavior:'smooth'});
      });
    }
  });

  elCancelEdit.addEventListener('click', ()=>{
    editingId=null; elBook.textContent='‚ûï Book now'; elCancelEdit.style.display='none'; setMsg('Edit cancelled.', true);
  });

  // Book / Save
  elBook.addEventListener('click', async ()=>{
    const deviceId=elDevice.value, date=elDate.value, start=elStart.value, end=elEnd.value;
    const name=elName.value.trim(), email=elEmail.value.trim(), notes=elNotes.value.trim();
    if(!deviceId||!date||!start||!end||!name||!email){ setMsg('Please complete all required fields.'); return; }
    if(end<=start){ setMsg('End time must be after start time.'); return; }
    if(editingId){
      await updateBooking(editingId, {deviceId,date,start,end,name,email,notes});
      editingId=null; elBook.textContent='‚ûï Book now'; elCancelEdit.style.display='none';
    } else {
      await insertBooking({deviceId,date,start,end,name,email,notes});
    }
  });

  // Initialize page
  (function init(){
    // default today
    document.getElementById('date').value = new Date().toISOString().slice(0,10);
    populateDevices();
    refreshTimeSelectors();
    listFuture();
    subscribeRealtime();
  })();
})();
</script>
</body>
</html>
